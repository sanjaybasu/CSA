---
title: "CSA: Health impact and cost-effectiveness of community-supported agriculture"
author: "Sanjay Basu"
date: "2/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Documents/Epi/Research/SDH/CSA")
```

## Health impact and cost-effectiveness of community-supported agriculture


```{r packages}
install.packages('nhanesA')
install.packages('stringr')
```

## NHANES pop

- use NHANES Population
- set eligibles to <200% FPL or Medicaid
- get variables for ASCVD inc, DM inc, DM microvasc complications, and all-cause mort [PCEs and RECODE]

```{r nhanes}
library(nhanesA)
demo <- nhanes('DEMO_H')
bmx <- nhanes('BMX_H')
tchol <- nhanes('TCHOL_H')
hdl <- nhanes('HDL_H')
bpq <- nhanes('BPQ_H')
ghb <- nhanes('GHB_H')
diq <- nhanes('DIQ_H')
biopro <- nhanes('BIOPRO_H')
albcr <- nhanes('ALB_CR_H')
bpx <- nhanes('BPX_H')
diet <- nhanes('DR1IFF_H')
rxq <- nhanes('RXQ_RX_H')
smq <- nhanes('SMQ_H')
mcq <- nhanes('MCQ_H')
occ <- nhanes('OCQ_H')
glu <- nhanes('GLU_H')
hic <- nhanes('HIQ_H')

demo2 <- nhanes('DEMO_I')
bmx2 <- nhanes('BMX_I')
tchol2 <- nhanes('TCHOL_I')
hdl2 <- nhanes('HDL_I')
bpq2 <- nhanes('BPQ_I')
ghb2 <- nhanes('GHB_I')
diq2 <- nhanes('DIQ_I')
biopro2 <- nhanes('BIOPRO_I')
albcr2 <- nhanes('ALB_CR_I')
bpx2 <- nhanes('BPX_I')
diet2 <- nhanes('DR1IFF_I')
rxq2 <- nhanes('RXQ_RX_I')
smq2 <- nhanes('SMQ_I')
mcq2 <- nhanes('MCQ_I')
occ2 <- nhanes('OCQ_I')
glu2 <- nhanes('GLU_I')
hic2 <- nhanes('HIQ_I')

demo <- nhanesTranslate('DEMO_H', 
                        colnames = c('RIAGENDR','RIDRETH1'), 
                        data=demo)
demo2 <- nhanesTranslate('DEMO_I', 
                        colnames = c('RIAGENDR','RIDRETH1'), 
                        data=demo2)



merged = merge(demo, bmx)
merged = merge(merged, tchol)
merged = merge(merged, hdl)
merged = merge(merged, bpq)
merged = merge(merged, ghb)
merged = merge(merged, diq)
merged = merge(merged, biopro)
merged = merge(merged, albcr)
merged = merge(merged, bpx)
merged = merge(merged, diet) 
merged = merge(merged, rxq)
merged = merge(merged, smq)
merged = merge(merged, mcq)
merged = merge(merged, occ)
merged = merge(merged, glu)
merged = merge(merged, hic)

merged2 = merge(demo2, bmx2)
merged2 = merge(merged2, tchol2)
merged2 = merge(merged2, hdl2)
merged2 = merge(merged2, bpq2)
merged2 = merge(merged2, ghb2)
merged2 = merge(merged2, diq2)
merged2 = merge(merged2, biopro2)
merged2 = merge(merged2, albcr2)
merged2 = merge(merged2, bpx2)
merged2 = merge(merged2, diet2) 
merged2 = merge(merged2, rxq2)
merged2 = merge(merged2, smq2)
merged2 = merge(merged2, mcq2)
merged2 = merge(merged2, occ2)
merged2 = merge(merged2, glu2)
merged2 = merge(merged2, hic2)

# https://www.r-bloggers.com/combining-dataframes-when-the-columns-dont-match/
rbind.match.columns <- function(input1, input2) {
    n.input1 <- ncol(input1)
    n.input2 <- ncol(input2)
 
    if (n.input2 < n.input1) {
        TF.names <- which(names(input2) %in% names(input1))
        column.names <- names(input2[, TF.names])
    } else {
        TF.names <- which(names(input1) %in% names(input2))
        column.names <- names(input1[, TF.names])
    }
 
    return(rbind(input1[, column.names], input2[, column.names]))
}
 
mergedt = rbind.match.columns(merged, merged2)

save(mergedt, file="merged.RData")
mergedt$eligible = ((mergedt$INDFMPIR<2) | (mergedt$HIQ031D==17))
table(mergedt$eligible)
mergedsub = mergedt[which(mergedt$eligible==1),]

age = mergedsub$RIDAGEYR
female = (mergedsub$RIAGENDR=="Female")
black = (mergedsub$RIDRETH1=="Non-Hispanic Black")
hisp = (mergedsub$RIDRETH1=="Other Hispanic")
bmi = mergedsub$BMXBMI
totchol = mergedsub$LBXTC
hdlc = mergedsub$LBDHDD
dm = (mergedsub$DIQ010==1) | 
  (mergedsub$LBXGH>=6.5) | 
  (mergedsub$LBXGLU>=126)
sercreat = mergedsub$LBXSCR
uralbcreat =  mergedsub$URDACT
sysbp = mergedsub$BPXSY1
rxbp = (mergedsub$BPQ040A==1)
cvdhist = (mergedsub$MCQ160F==1)|(mergedsub$MCQ160F==1)
cvdhist[is.na(cvdhist)]=0
hgba1c = mergedsub$LBXGH
cursmoke = (mergedsub$SMQ040<3)

library(stringr)
statin = grepl("STATIN",mergedsub$RXDDRUG)
oralrx = grepl("METFORMIN",mergedsub$RXDDRUG)|grepl("GLIPIZIDE",mergedsub$RXDDRUG)
anticoag = grepl("WARFARIN",mergedsub$RXDDRUG)
```

## Calculate baseline risk scores, 10 year and lifetime horizons

1. Yadlowsky S, Hayward RA, Sussman JB, McClelland RL, Min Y, Basu S. Clinical Implications of Revised Pooled Cohort Equations for Estimating Atherosclerotic Cardiovascular Disease Risk. Ann Intern Med. ;169:20–29. doi: 10.7326/M17-3011

2.Basu S, Sussman JB, Berkowitz SA, Hayward RA, Yudkin JS. Development and validation of Risk Equations for Complications Of type 2 Diabetes (RECODe) using individual participant data from randomised trials. Lancet Diabetes Endocrinol. 2017;5(10):788-798.

3. Sanjay Basu, Jeremy B. Sussman, Seth A. Berkowitz, Rodney A. Hayward, Alain G. Bertoni, Adolfo Correa, Stanford Mwasongwe, John S. Yudkin. Validation of Risk Equations for Complications of Type 2 Diabetes (RECODe) Using Individual Participant Data From Diverse Longitudinal Cohorts in the U.S. Diabetes Care Mar 2018, 41 (3) 586-595; DOI: 10.2337/dc17-2002




```{r baseline risk scores, 10 year}

# ASCVD


ascvd   = ( 1.0*nhanes$female / (1.0 + exp( - (
  -12.823110 +
    0.106501 * as.numeric(age) +
    0.432440 * as.numeric(black) +
    0.000056 * (as.numeric(sysbp) ^ 2) +
    0.017666 * as.numeric(sysbp) +
    0.731678 * as.numeric(rxbp) +
    0.943970 * as.numeric(dm) +
    1.009790 * as.numeric(cursmoke) +
    0.151318 * (as.numeric(totchol) / as.numeric(hdlc)) +
    -0.008580 * as.numeric(age) * as.numeric(black) +
    -0.003647 * as.numeric(sysbp) * as.numeric(rxbp) +
    0.006208 * as.numeric(sysbp) * as.numeric(black) +
    0.152968 * as.numeric(black) * as.numeric(rxbp) +
    -0.000153 * as.numeric(age) * as.numeric(sysbp) +
    0.115232 * as.numeric(black) * as.numeric(dm) +
    -0.092231 * as.numeric(black) * as.numeric(cursmoke) +
    0.070498 * as.numeric(black) * (as.numeric(totchol) / as.numeric(hdlc)) +
    -0.000173 * as.numeric(black)  * as.numeric(sysbp) * as.numeric(rxbp) +
    -0.000094 * as.numeric(age) * as.numeric(sysbp) * as.numeric(black)))))+
  (1.0*(1-nhanes$female) / (1.0 + exp( - (
  -11.679980 +
    0.064200 * as.numeric(age) +
    0.482835 * as.numeric(black) +
    -0.000061 * (as.numeric(sysbp) ^ 2) +
    0.038950 * as.numeric(sysbp) +
    2.055533 * as.numeric(rxbp) +
    0.842209 * as.numeric(dm) +
    0.895589 * as.numeric(cursmoke) +
    0.193307 * (as.numeric(totchol) / as.numeric(hdlc)) +
    -0.014207 * as.numeric(sysbp) * as.numeric(rxbp) +
    0.011609 * as.numeric(sysbp) * as.numeric(black) +
    -0.119460 * as.numeric(rxbp) * as.numeric(black) +
    0.000025 * as.numeric(age) * as.numeric(sysbp) +
    -0.077214 * as.numeric(black) * as.numeric(dm) +
    -0.226771 * as.numeric(black) * as.numeric(cursmoke) +
    -0.117749 * (as.numeric(totchol) / as.numeric(hdlc)) * as.numeric(black) +
    0.004190 * as.numeric(black) * as.numeric(rxbp) * as.numeric(sysbp) +
    -0.000199 * as.numeric(black) * as.numeric(age) * as.numeric(sysbp)))))

      
# DM incidence

# DM neph

# DM retin

# DM neuro

# All cause mort



```

```{r baseline risk scores, lifetime}


```


## Calculate change in incidence and mortality due to change in HEI, translate into QALYs, 10year and lifetime, healthcare and societal perspective [where latter includes productivity and agriculture econ effects]

Treatment effect 1:  13% (95%CI 9% to 17%) increase in diet quality as measured by HEI, AHEI, or DASH Diet index

Treatment effect 2: 7% (95%CI 3% to 11%) increase in diet quality as measured by HEI, AHEI, or DASH Diet index

Hazard Ratio for CVD Incidence for 20% change in diet quality: 0.91 (0.84–0.97)2

Hazard ratio for incident diabetes for 10% change in diet quality4: 0.84 (95%CI 0.78–0.90)

Change in HbA1c per 10% change in diet quality (in individuals with diabetes):3 -0.32 (95% CI -0.41 to -0.23%) (one time drop, assumed sustained)

Hazard Ratio for all-cause mortality for 20% change in diet quality1: 0.83 (95%CI: 0.78 to 0.88)


Process:  Converted raw data from Just Roots trial to % change in diet quality and averaged across 3 diet quality scores (HEI 2010, AHEI 2010, DASH Diet Score). Then related change in diet quality to change in outcome using randomized trials (when available) or prospective cohort studies that examined change in diet quality (as opposed to associations with baseline diet quality) to estimate effects. All effects had to be in at least 1 of the above 3 diet quality indices. I converted effect estimate to being for either a 10% or 20% change in diet quality, as specified above, based on information in cited articles. If effect estimates presented for more than 1 diet quality index, I averaged across available indices.  


1. 	Sotos-Prieto M, Bhupathiraju SN, Mattei J, et al. Association of Changes in Diet Quality with Total and Cause-Specific Mortality. N Engl J Med. 2017;377(2):143-153. doi:10.1056/NEJMoa1613502
2. 	Sotos-Prieto Mercedes, Bhupathiraju Shilpa N., Mattei Josiemer, et al. Changes in Diet Quality Scores and Risk of Cardiovascular Disease Among US Men and Women. Circulation. 2015;132(23):2212-2219. doi:10.1161/CIRCULATIONAHA.115.017158
3. 	Schwingshackl L, Chaimani A, Hoffmann G, Schwedhelm C, Boeing H. A network meta-analysis on the comparative efficacy of different dietary approaches on glycaemic control in patients with type 2 diabetes mellitus. Eur J Epidemiol. 2018;33(2):157-170. doi:10.1007/s10654-017-0352-x
4. 	Ley SH, Pan A, Li Y, et al. Changes in Overall Diet Quality and Subsequent Type 2 Diabetes Risk: Three U.S. Prospective Cohorts. Diabetes Care. September 2016:dc160574. doi:10.2337/dc16-0574

